#!/bin/zsh

# Get macOS software updates, update Homebrew, npm, Ruby packages, dotfiles and some other software

set -e
set -u
set -o pipefail

header() {
  echo "$(tput sgr 0 1)$(tput setaf 6)$1$(tput sgr0)"
}

warning() {
  tput setaf 1
  echo "/!\\ $1 /!\\"
  tput sgr0
}

# Dotfiles
# dotfiles
# echo

caller=$1

if [[ $caller != "daily" ]]; then
  # Ask for the administrator password upfront
  warning "Activate sudo"
  sudo echo "Sudo activated!"
  echo

  # macOS
  header "Updating macOS system..."
  sudo softwareupdate -ia --verbose
  echo
  # App Store
  # https://github.com/mas-cli/mas?tab=readme-ov-file#%EF%B8%8F-known-issues
  header "Updating apps from App Store..."
  sudo mas upgrade
  echo
fi

# Homebrew
header "Updating Homebrew packages..."
brew update
brew upgrade
brew cleanup
brew doctor
echo

if [[ $caller != "daily" ]]; then
# Raycast
header "Updating Raycast and its extensions..."
open raycast://extensions/raycast/raycast/check-for-updates
open raycast://extensions/raycast/raycast/check-for-extension-updates
fi

# npm
header "Updating global pnpm modules..."
pnpm update -g
echo

# Print Job success message and date
header "Job done! $(date)"
